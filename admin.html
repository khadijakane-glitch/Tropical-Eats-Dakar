<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Tropical Eats Dakar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #FFFBEA;
    }
  </style>
</head>
<body class="p-8">

  <h1 class="text-3xl font-bold mb-6 text-primary">Administration Tropical Eats Dakar</h1>

  <section id="login-section" class="max-w-sm mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">Connexion Admin</h2>
    <form id="login-form" autocomplete="off">
      <label class="block mb-2">
        Nom d'utilisateur
        <input type="text" id="username" required class="border rounded w-full p-2" autocomplete="username" />
      </label>
      <label class="block mb-4">
        Mot de passe
        <input type="password" id="password" required class="border rounded w-full p-2" autocomplete="current-password" />
      </label>
      <button type="submit" class="bg-primary text-white rounded px-4 py-2 hover:bg-darkGreen transition w-full font-semibold">Se connecter</button>
    </form>
  </section>

  <section id="admin-panel" class="hidden max-w-6xl mx-auto bg-white p-6 rounded shadow mt-8 overflow-auto">
    <h2 class="text-2xl font-semibold mb-4">Gestion des produits</h2>
    <table class="w-full border-collapse border border-gray-300 mb-6">
      <thead>
        <tr class="bg-primary text-white">
          <th class="border border-gray-300 p-2">Catégorie</th>
          <th class="border border-gray-300 p-2">Produit</th>
          <th class="border border-gray-300 p-2">Prix (CFA)</th>
          <th class="border border-gray-300 p-2">Stock</th>
          <th class="border border-gray-300 p-2">Image URL</th>
        </tr>
      </thead>
      <tbody id="product-table-body"></tbody>
    </table>
    <button id="save-btn" class="bg-secondary text-white px-4 py-2 rounded hover:bg-yellow-500 transition font-semibold">Enregistrer les modifications</button>
  </section>

<script>
  const ADMIN_USER = 'admin';
  const ADMIN_PASS = 'password123';

  const loginSection = document.getElementById('login-section');
  const adminPanel = document.getElementById('admin-panel');
  const loginForm = document.getElementById('login-form');
  const productTableBody = document.getElementById('product-table-body');
  const saveBtn = document.getElementById('save-btn');

  // Categories data from main page or fallback if opened standalone
  let categories = window.opener && window.opener._categories ? window.opener._categories : [
    { name: 'Boosters', description: '', products: [] },
    { name: 'Candy', description: '', products: [] },
    { name: 'Cold-pressed oils', description: '', products: [] },
    { name: 'Detox', description: '', products: [] },
    { name: 'Dried Fruits', description: '', products: [] },
    { 
      name: 'Fresh Juices', description: '', products: [
        { id: 'bissap', name: 'Bissap', price: 1200, stock: 20, image: 'https://example.com/images/bissap.jpg' },
        { id: 'bouye-mandarine', name: 'Bouye mandarine', price: 2000, stock: 20, image: 'https://example.com/images/bouye.jpg' },
        { id: 'cucumber-lemonade', name: 'Cucumber lemonade', price: 2000, stock: 20, image: 'https://example.com/images/cucumber.jpg' },
        { id: 'ginger-juice', name: 'Ginger juice', price: 2000, stock: 20, image: 'https://example.com/images/ginger.jpg' },
        { id: 'grapefruit-lemonade', name: 'Grapefruit lemonade', price: 1800, stock: 20, image: 'https://example.com/images/grapefruit.jpg' },
        { id: 'mango-cocktail', name: 'Mango cocktail', price: 1500, stock: 20, image: 'https://example.com/images/mango.jpg' },
        { id: 'moringa-juice', name: 'Moringa juice', price: 1700, stock: 20, image: 'https://example.com/images/moringa.jpg' },
        { id: 'sweet-green-juice', name: 'Sweet green juice', price: 1400, stock: 20, image: 'https://example.com/images/sweet-green.jpg' },
        { id: 'tamarind-juice', name: 'Tamarind juice', price: 2200, stock: 20, image: 'https://example.com/images/tamarind.jpg' },
      ] 
    },
    { name: 'Healthy Snacks', description: '', products: [] },
    { name: 'Popsicles', description: '', products: [] },
    { name: 'Spices', description: '', products: [] },
    { name: 'Syrups', description: '', products: [] },
    { name: 'Vegan Milk', description: '', products: [] },
    { name: 'Wellness', description: '', products: [] },
  ];

  // Load saved data from localStorage for persistence
  function loadSavedData(){
    const stockData = localStorage.getItem('productStock');
    const priceData = localStorage.getItem('productPrices');
    const imageData = localStorage.getItem('productImages');

    if(stockData){
      const stocks = JSON.parse(stockData);
      categories.forEach(cat => cat.products.forEach(p => { if(stocks[p.id] !== undefined) p.stock = stocks[p.id]; }));
    }
    if(priceData){
      const prices = JSON.parse(priceData);
      categories.forEach(cat => cat.products.forEach(p => { if(prices[p.id] !== undefined) p.price = prices[p.id]; }));
    }
    if(imageData){
      const images = JSON.parse(imageData);
      categories.forEach(cat => cat.products.forEach(p => { if(images[p.id] !== undefined) p.image = images[p.id]; }));
    }
  }

  // Render editable product rows
  function renderProductTable(){
    productTableBody.innerHTML = '';
    categories.forEach(cat => {
      cat.products.forEach(prod => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border border-gray-300 p-2">${cat.name}</td>
          <td class="border border-gray-300 p-2">${prod.name}</td>
          <td class="border border-gray-300 p-2">
            <input type="number" min="1" value="${prod.price}" data-id="${prod.id}" class="price-input w-24 p-1 border rounded text-center" />
          </td>
          <td class="border border-gray-300 p-2">
            <input type="number" min="0" value="${prod.stock}" data-id="${prod.id}" class="stock-input w-20 p-1 border rounded text-center" />
          </td>
          <td class="border border-gray-300 p-2">
            <input type="url" value="${prod.image || ''}" data-id="${prod.id}" class="image-input w-full p-1 border rounded" />
          </td>
        `;
        productTableBody.appendChild(tr);
      });
    });
  }

  // Save modifications to localStorage and update data structure
  function saveChanges(){
    const prices = {};
    const stocks = {};
    const images = {};

    for(const input of document.querySelectorAll('.price-input')){
      const id = input.dataset.id;
      const val = parseInt(input.value, 10);
      if(isNaN(val) || val < 1) {
        alert('Prix invalide détecté');
        return false;
      }
      prices[id] = val;
    }
    for(const input of document.querySelectorAll('.stock-input')){
      const id = input.dataset.id;
      const val = parseInt(input.value, 10);
      if(isNaN(val) || val < 0) {
        alert('Stock invalide détecté');
        return false;
      }
      stocks[id] = val;
    }
    for(const input of document.querySelectorAll('.image-input')){
      const id = input.dataset.id;
      images[id] = input.value.trim();
    }

    // Update categories array
    categories.forEach(cat => {
      cat.products.forEach(p => {
        if(prices[p.id] !== undefined) p.price = prices[p.id];
        if(stocks[p.id] !== undefined) p.stock = stocks[p.id];
        if(images[p.id] !== undefined) p.image = images[p.id];
      });
    });

    // Save to localStorage to persist across reloads
    localStorage.setItem('productPrices', JSON.stringify(prices));
    localStorage.setItem('productStock', JSON.stringify(stocks));
    localStorage.setItem('productImages', JSON.stringify(images));
    alert('Modifications enregistrées avec succès. Rechargez la page principale pour voir les mises à jour.');
    return true;
  }

  // Login form handler
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;

    if(user === ADMIN_USER && pass === ADMIN_PASS){
      loginSection.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      loadSavedData();
      renderProductTable();
    } else {
      alert('Identifiants incorrects');
    }
  });

  saveBtn.addEventListener('click', () => {
    saveChanges();
  });
</script>

</body>
</html>
