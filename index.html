<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tropical Eats Dakar - Alimentation Saine & Fraîche</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Stripe.js for payment -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #FFFBEA; }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .hidden { display: none; }
  </style>
</head>
<body class="hero-pattern">

<!-- Header -->
<header class="bg-white shadow-md sticky top-0 z-50 p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold text-primary">Tropical Eats Dakar</h1>
  <nav>
    <a href="#menu" class="font-medium text-textDark hover:text-primary mx-2">Menu</a>
    <a href="#contact" class="font-medium text-textDark hover:text-primary mx-2">Contact</a>
    <a href="admin.html" class="font-medium text-secondary mx-2">Admin</a>
  </nav>
  <div class="relative text-textDark">
    <button aria-label="Panier" id="cart-button" class="bg-secondary text-white rounded px-3 py-1 relative">
      Panier <span id="cart-count" class="absolute -top-2 -right-2 bg-yellow-500 rounded-full w-5 h-5 flex items-center justify-center text-xs">0</span>
    </button>
  </div>
</header>

<!-- Categories and Products Section -->
<section id="menu" class="py-12 container mx-auto px-4">
  <h2 class="text-3xl font-bold mb-8 text-textDark">Découvrez nos catégories</h2>
  <div id="categories-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
</section>

<!-- Cart and Checkout Modal -->
<div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 hidden" aria-hidden="true">
  <div class="bg-white rounded-lg shadow-lg max-w-lg w-full max-h-[90vh] overflow-auto p-6 relative" role="dialog" aria-modal="true" aria-labelledby="cart-title">
    <button id="close-cart" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" aria-label="Fermer le panier">&times;</button>
    <h3 id="cart-title" class="text-2xl font-bold mb-4 text-primary">Votre Panier</h3>
    <div id="cart-items" class="mb-4"></div>

    <div class="mb-4">
      <label for="delivery-distance" class="block font-semibold mb-1">Distance de livraison (km):</label>
      <input type="number" id="delivery-distance" min="0" value="0" class="border p-2 rounded w-full" />
      <p id="delivery-fee" class="mt-1 font-semibold">Frais de livraison: 0 CFA</p>
    </div>

    <h4 class="font-semibold mb-2">Choisissez le mode de paiement :</h4>
    <div id="payment-methods" class="mb-4 space-y-2">
      <label><input type="radio" name="payment" value="card" checked> Carte bancaire (Stripe Test)</label><br>
      <label><input type="radio" name="payment" value="orange-money"> Orange Money (à venir)</label><br>
      <label><input type="radio" name="payment" value="wave"> Wave (à venir)</label><br>
      <label><input type="radio" name="payment" value="cod"> Paiement à la livraison (Cash on Delivery)</label>
    </div>

    <!-- Stripe Card Element Container -->
    <div id="card-element" class="mb-4"></div>
    <div id="card-errors" role="alert" class="text-red-600 mb-4"></div>

    <button id="checkout-btn" class="bg-primary text-white px-6 py-2 rounded hover:bg-darkGreen transition w-full">Valider la commande</button>
  </div>
</div>

<!-- Contact Section -->
<section id="contact" class="py-16 bg-background">
  <div class="container mx-auto px-4 max-w-2xl text-center">
    <h2 class="text-3xl font-bold text-textDark mb-4">Contactez-nous</h2>
    <p class="text-gray-700 mb-6">Pour questions, commandes ou collaborations, contactez-nous via WhatsApp, email, ou rendez-nous visite en magasin.</p>
    <div class="space-y-3">
      <a href="https://wa.me/xxxxxxxxxx" target="_blank" rel="noopener noreferrer" class="inline-block bg-primary hover:bg-darkGreen text-white py-3 px-6 rounded-full transition duration-300">WhatsApp</a>
      <a href="mailto:contact@tropicaleatsdakar.sn" class="inline-block border-2 border-primary text-primary hover:bg-primary hover:text-white py-3 px-6 rounded-full transition duration-300">Email</a>
      <p class="text-textDark mt-4">Adresse: Dakar, Sénégal</p>
      <iframe 
          src="https://maps.google.com/maps?q=Dakar%2C%20Senegal&t=&z=13&ie=UTF8&iwloc=&output=embed" 
          frameborder="0" 
          class="w-full h-48 rounded-lg mt-4" 
          aria-label="Carte de la localisation Tropical Eats Dakar" 
          allowfullscreen="">
      </iframe>
    </div>
  </div>
</section>

<script>
  // -----------------------
  // Data: Categories & Products
  // -----------------------
  // Initial stock can be updated from admin
  const categories = [
    { name: 'Boosters', description: 'Shots d\'immunité et mélanges énergétiques', products: [] },
    { name: 'Candy', description: 'Bonbons et friandises saines', products: [] },
    { name: 'Cold-pressed oils', description: 'Huiles pressées à froid', products: [] },
    { name: 'Detox', description: 'Produits detox', products: [] },
    { name: 'Dried Fruits', description: 'Fruits secs', products: [] },
    { name: 'Fresh Juices', description: 'Jus frais naturels et sains', products: [
        { id: 'bissap', name: 'Bissap', price: 1200, stock: 20, image: 'https://example.com/images/bissap.jpg' },
        { id: 'bouye-mandarine', name: 'Bouye mandarine', price: 2000, stock: 20, image: 'https://example.com/images/bouye.jpg' },
        { id: 'cucumber-lemonade', name: 'Cucumber lemonade', price: 2000, stock: 20, image: 'https://example.com/images/cucumber.jpg' },
        { id: 'ginger-juice', name: 'Ginger juice', price: 2000, stock: 20, image: 'https://example.com/images/ginger.jpg' },
        { id: 'grapefruit-lemonade', name: 'Grapefruit lemonade', price: 1800, stock: 20, image: 'https://example.com/images/grapefruit.jpg' },
        { id: 'mango-cocktail', name: 'Mango cocktail', price: 1500, stock: 20, image: 'https://example.com/images/mango.jpg' },
        { id: 'moringa-juice', name: 'Moringa juice', price: 1700, stock: 20, image: 'https://example.com/images/moringa.jpg' },
        { id: 'sweet-green-juice', name: 'Sweet green juice', price: 1400, stock: 20, image: 'https://example.com/images/sweet-green.jpg' },
        { id: 'tamarind-juice', name: 'Tamarind juice', price: 2200, stock: 20, image: 'https://example.com/images/tamarind.jpg' },
    ]},
    { name: 'Healthy Snacks', description: 'Snacks sains à grignoter', products: [] },
    { name: 'Popsicles', description: 'Glaces artisanales', products: [] },
    { name: 'Spices', description: 'Épices naturelles', products: [] },
    { name: 'Syrups', description: 'Sirops naturels', products: [] },
    { name: 'Vegan Milk', description: 'Laits végétaux', products: [] },
    { name: 'Wellness', description: 'Produits bien-être', products: [] },
  ];

  // -----------------------
  // LocalStorage Helpers for stock and cart persistence
  // -----------------------
  function loadStock() {
    const savedStock = localStorage.getItem('productStock');
    if(savedStock) {
      const stock = JSON.parse(savedStock);
      categories.forEach(cat => {
        cat.products.forEach(prod => {
          if(stock.hasOwnProperty(prod.id)) prod.stock = stock[prod.id];
        });
      });
    }
  }
  function saveStock() {
    const stockObj = {};
    categories.forEach(cat => {
      cat.products.forEach(prod => {
        stockObj[prod.id] = prod.stock;
      });
    });
    localStorage.setItem('productStock', JSON.stringify(stockObj));
  }

  let cart = {};
  function loadCart() {
    const savedCart = localStorage.getItem('cart');
    if(savedCart) cart = JSON.parse(savedCart);
  }
  function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
  }
  function updateCartCount() {
    const count = Object.values(cart).reduce((a, b) => a + b, 0);
    document.getElementById('cart-count').textContent = count;
  }

  // -----------------------
  // Rendering Functions
  // -----------------------
  function findProduct(productId) {
    for(const cat of categories){
      const found = cat.products.find(p => p.id === productId);
      if(found) return found;
    }
    return null;
  }

  function renderCategories() {
    const container = document.getElementById('categories-container');
    container.innerHTML = '';
    categories.forEach(cat => {
      if(cat.products.length === 0) return;  // Skip empty categories for now
      const catDiv = document.createElement('div');
      catDiv.className = 'category border rounded p-4 bg-white shadow-md';
      const sortedProducts = [...cat.products].sort((a,b) => a.name.localeCompare(b.name));
      catDiv.innerHTML = `
        <h3 class="font-semibold text-xl mb-2 text-primary">${cat.name}</h3>
        <p class="text-gray-600 mb-4">${cat.description}</p>
      `;
      // Products grid
      const productsGrid = document.createElement('div');
      productsGrid.className = 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3';

      sortedProducts.forEach(prod => {
        const prodCard = document.createElement('div');
        prodCard.className = 'product-card border rounded p-4 bg-background flex flex-col items-center';
        prodCard.innerHTML = `
          <img src="${prod.image ?? 'https://via.placeholder.com/150'}" alt="${prod.name}" class="w-40 h-40 object-cover rounded mb-2">
          <h4 class="font-semibold text-lg mb-1">${prod.name}</h4>
          <p class="mb-1">Prix: <span>${prod.price} CFA</span></p>
          <p class="mb-1">Stock: <span id="stock-${prod.id}">${prod.stock}</span></p>
          <div class="flex items-center gap-2 mt-auto">
            <input id="qty-${prod.id}" type="number" min="1" max="${prod.stock}" value="1" class="border rounded w-16 p-1" aria-label="Quantité pour ${prod.name}" />
            <button onclick="addToCart('${prod.id}')" class="bg-primary text-white px-3 py-1 rounded hover:bg-darkGreen transition">Ajouter</button>
          </div>
        `;
        productsGrid.appendChild(prodCard);
      });

      catDiv.appendChild(productsGrid);
      container.appendChild(catDiv);
    });
  }

  function addToCart(productId) {
    const product = findProduct(productId);
    if(!product) return alert('Produit non trouvé');
    const qtyInput = document.getElementById(`qty-${productId}`);
    let qty = parseInt(qtyInput.value, 10);
    if(isNaN(qty) || qty < 1) return alert('Entrer une quantité valide');
    const currentQty = cart[productId] || 0;
    if(currentQty + qty > product.stock) {
      return alert(`La quantité dépasse le stock disponible (${product.stock})`);
    }
    cart[productId] = currentQty + qty;
    saveCart();
    updateCartCount();
    alert(`${qty} × ${product.name} ajouté(s) au panier.`);
  }

  // -----------------------
  // Cart Modal and Checkout Logic
  // -----------------------

  const cartButton = document.getElementById('cart-button');
  const cartModal = document.getElementById('cart-modal');
  const closeCartBtn = document.getElementById('close-cart');
  const cartItemsContainer = document.getElementById('cart-items');
  const deliveryDistanceInput = document.getElementById('delivery-distance');
  const deliveryFeeEl = document.getElementById('delivery-fee');
  const checkoutBtn = document.getElementById('checkout-btn');
  const paymentMethods = document.getElementsByName('payment');
  const cardElementDiv = document.getElementById('card-element');
  const cardErrors = document.getElementById('card-errors');

  // Delivery fee calculation: Flat 200 CFA per km
  function calculateDeliveryFee(distanceKm) {
    const feePerKm = 200;
    return distanceKm > 0 ? feePerKm * distanceKm : 0;
  }

  function renderCartItems() {
    cartItemsContainer.innerHTML = '';
    if(Object.keys(cart).length === 0){
      cartItemsContainer.innerHTML = '<p>Votre panier est vide.</p>';
      checkoutBtn.disabled = true;
      cardElementDiv.style.display = 'none';
      return;
    }
    checkoutBtn.disabled = false;
    cardElementDiv.style.display = '';

    let total = 0;
    for(const [productId, qty] of Object.entries(cart)){
      const product = findProduct(productId);
      if(!product) continue;
      const lineTotal = product.price * qty;
      total += lineTotal;

      const itemDiv = document.createElement('div');
      itemDiv.className = 'flex justify-between items-center mb-2';
      itemDiv.innerHTML = `
        <span>${qty} × ${product.name}</span>
        <span>${lineTotal} CFA</span>
        <button aria-label="Retirer un article" data-id="${productId}" class="remove-item px-2 text-red-600 hover:text-red-800">×</button>
      `;
      cartItemsContainer.appendChild(itemDiv);
    }
    const deliveryKm = parseInt(deliveryDistanceInput.value, 10) || 0;
    const deliveryFee = calculateDeliveryFee(deliveryKm);
    deliveryFeeEl.textContent = `Frais de livraison: ${deliveryFee} CFA`;

    const grandTotal = total + deliveryFee;

    const totalDiv = document.createElement('div');
    totalDiv.className = 'font-bold mt-4 text-lg flex justify-between';
    totalDiv.innerHTML = `
      <span>Total (avec livraison)</span>
      <span>${grandTotal} CFA</span>
    `;
    cartItemsContainer.appendChild(totalDiv);
  }

  cartButton.addEventListener('click', () => {
    renderCartItems();
    cartModal.classList.remove('hidden');
  });
  closeCartBtn.addEventListener('click', () => {
    cartModal.classList.add('hidden');
    cardErrors.textContent = '';
    stripeCard.clear();
  });

  // Remove item in cart
  cartItemsContainer.addEventListener('click', e => {
    if(e.target.classList.contains('remove-item')){
      const id = e.target.getAttribute('data-id');
      if(id in cart){
        delete cart[id];
        saveCart();
        updateCartCount();
        renderCartItems();
      }
    }
  });

  deliveryDistanceInput.addEventListener('input', () => {
    renderCartItems();
  });

  // -----------------------
  // Stripe Setup for card payments (test mode)
  // -----------------------
  const stripe = Stripe('pk_test_51NOq...YOUR_PUBLISHABLE_KEY_HERE...'); // Replace with your Stripe test publishable key

  const elements = stripe.elements();
  const style = {
    base: {
      color: '#32325d',
      fontFamily: '"Poppins", sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '16px',
      '::placeholder': {
        color: '#a0aec0'
      }
    },
    invalid: {
      color: '#fa755a',
      iconColor: '#fa755a'
    }
  };
  const stripeCard = elements.create('card', {style});
  stripeCard.mount('#card-element');

  stripeCard.on('change', event => {
    cardErrors.textContent = event.error ? event.error.message : '';
  });

  // -----------------------
  // Checkout handler
  // -----------------------
  checkoutBtn.addEventListener('click', async () => {
    if(Object.keys(cart).length === 0) {
      alert("Votre panier est vide.");
      return;
    }
    let selectedPayment = 'card';
    paymentMethods.forEach(pm => { if(pm.checked) selectedPayment = pm.value; });

    if(selectedPayment === 'card') {
      // Basic Stripe payment simulation (without backend)
      // Normally, you create payment intent server-side, provide its client secret here for confirmCardPayment
      // For demo, just do token creation and fake success

      checkoutBtn.disabled = true;
      cardErrors.textContent = '';

      const {token, error} = await stripe.createToken(stripeCard);
      if(error) {
        cardErrors.textContent = error.message;
        checkoutBtn.disabled = false;
        return;
      }
      // In real app: send token.id & cart info & delivery fee to backend for charge

      alert(`Paiement par carte simulé avec succès. Token: ${token.id}. Commande enregistrée.`);

      // Simulate order success: clear cart & update stock
      updateStockFromOrder();
      cart = {};
      saveCart();
      updateCartCount();
      cartModal.classList.add('hidden');
      stripeCard.clear();
      checkoutBtn.disabled = false;

    } else if(selectedPayment === 'cod') {
      alert('Commande passée avec paiement à la livraison. Merci !');

      updateStockFromOrder();
      cart = {};
      saveCart();
      updateCartCount();
      cartModal.classList.add('hidden');

    } else {
      alert('Options Orange Money et Wave seront intégrées bientôt.');
    }
  });

  // Update stock after successful order
  function updateStockFromOrder() {
    for(const [pid, qty] of Object.entries(cart)){
      const product = findProduct(pid);
      if(product) {
        product.stock = Math.max(product.stock - qty, 0);
        document.getElementById(`stock-${pid}`).textContent = product.stock;
      }
    }
    saveStock();
  }

  // -----------------------
  // Initialize everything
  // -----------------------
  loadStock();
  loadCart();
  renderCategories();
  updateCartCount();

  // Expose for admin page to access and update stock/images
  window._categories = categories;
  window._saveStock = saveStock;

</script>
</body>
</html>
